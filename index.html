<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DL Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2B3A67',   // Softer deep blue for headers
                        secondary: '#4681F4',  // Vibrant blue for buttons
                        accent: '#34D399',     // Softer green for success states
                        background: '#F9FAFB', // Light neutral background
                        error: '#F87171',      // Softer red for errors
                        neutral: '#6B7280',    // Gray for secondary text
                        sidebar: 'linear-gradient(180deg, #1E293B 0%, #2B3A67 100%)', // Gradient for sidebar
                        card: 'rgba(255, 255, 255, 0.9)', // Glassmorphism effect for cards
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.1)',
                        'custom': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.03)',
                    },
                    backdropBlur: {
                        xs: '4px',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-down': 'slideDown 0.5s ease-in-out',
                        'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' },
                        },
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(107, 114, 128, 0.5);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(107, 114, 128, 0.7);
        }
        /* Sticky table headers */
        th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(249, 250, 251, 0.9);
            backdrop-filter: blur(4px);
        }
        /* Glassmorphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-background min-h-screen font-sans antialiased text-gray-900">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
        <div class="glass p-8 rounded-2xl shadow-glass w-full max-w-md transform animate-fade-in">
            <h2 class="text-2xl font-semibold text-primary mb-6 text-center">Welcome to DL Generator</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-neutral">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all bg-white/80" placeholder="Enter username" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-neutral">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all bg-white/80" placeholder="Enter password" required>
                </div>
                <button type="submit" class="w-full bg-secondary text-white py-3 px-4 rounded-lg hover:bg-blue-500 focus:ring-4 focus:ring-blue-200 transition-all font-medium">Login</button>
            </form>
            <p id="loginError" class="text-error text-sm mt-4 text-center hidden">Invalid credentials. Please try again.</p>
        </div>
    </div>

    <!-- Main Layout -->
    <div id="mainContent" class="hidden flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gradient-to-b from-gray-800 to-primary text-white flex-shrink-0">
            <div class="p-6">
                <h1 class="text-2xl font-semibold flex items-center gap-2">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    DL Generator
                </h1>
            </div>
            <nav class="mt-4">
                <a href="#" id="dlGeneratorMenu" class="flex items-center gap-3 px-6 py-3 bg-white bg-opacity-10 text-white hover:bg-opacity-20 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    DL Generator
                </a>
                <a href="#" id="userManagementMenu" class="flex items-center gap-3 px-6 py-3 text-gray-300 hover:bg-white hover:bg-opacity-10 hover:text-white transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    User Management
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="glass px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-primary">Dashboard</h2>
                <div class="flex items-center gap-3">
                    <span id="userDisplay" class="text-neutral font-medium"></span>
                    <button id="logoutButton" class="text-error font-medium hover:underline flex items-center gap-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Logout
                    </button>
                </div>
            </header>

            <!-- Content -->
            <main class="flex-1 p-6 overflow-y-auto">
                <!-- DL Generator Section -->
                <div id="dlGeneratorSection" class="glass rounded-2xl shadow-glass p-8">
                    <!-- Mode Selection -->
                    <section class="mb-4">
                        <h2 class="text-xl font-semibold text-primary mb-3">Select Processing Mode</h2>
                        <select id="modeSelect" class="block w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all bg-white/80 shadow-sm">
                            <option value="">Select Mode</option>
                            <option value="DL Only">DL Only</option>
                            <option value="DL w/ Transmittal">DL w/ Transmittal</option>
                            <option value="Transmittal Only">Transmittal Only</option>
                        </select>
                    </section>

                    <div id="statusDisplay" class="p-4 mb-4 text-sm hidden text-blue-800 rounded-lg bg-blue-50 dark:bg-gray-800 dark:text-blue-400" role="alert">
                        <p> <span class="font-medium">Info alert!</span> <span id="templateStatusText"></span></p>
                    </div>

                    <!-- Selection Section -->
                    <section id="selectionSection" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div>
                            <h2 class="text-lg font-medium text-primary mb-2">Template Folder</h2>
                            <select id="folderSelect" class="block w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all bg-white/80 shadow-sm">
                                <option value="">Select Folder</option>
                            </select>
                        </div>
                        <div>
                            <h2 class="text-lg font-medium text-primary mb-2">DL Type</h2>
                            <select id="dlTypeSelect" class="block w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all bg-white/80 shadow-sm">
                                <option value="">Select DL Type</option>
                            </select>
                        </div>
                        <div>
                            <h2 class="text-lg font-medium text-primary mb-2">Content File</h2>
                            <select id="templateSelect" class="block w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all bg-white/80 shadow-sm">
                                <option value="">Select Template</option>
                            </select>
                        </div>
                    </section>

                    <div id="contentStatus" class="p-4 mb-4 text-sm hidden text-blue-800 rounded-lg bg-blue-50 dark:bg-gray-800 dark:text-blue-400" role="alert">
                        <p> <span class="font-medium">Info alert!</span> <span id="contentStatusText"></span></p>
                    </div>

                    <!-- Placeholders Display -->
                    <section id="placeholdersDisplay" class="hidden mb-8 p-4 bg-white/50 rounded-lg shadow-sm animate-slide-down">
                        <h3 class="text-lg font-medium text-primary flex items-center gap-2 mb-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            Detected Placeholders
                        </h3>
                        <ul id="placeholdersList" class="list-disc list-inside text-neutral space-y-1 max-h-40 overflow-y-auto"></ul>
                    </section>

                     <div id="templatecontentStatus" class="p-4 mb-4 text-sm hidden text-blue-800 rounded-lg bg-blue-50 dark:bg-gray-800 dark:text-blue-400" role="alert">
                        <p> <span class="font-medium">Info alert!</span> <span id="templatecontentStatusText"></span></p>
                    </div>

                    <!-- File Upload and Processing -->
                    <section id="uploadSection" class="hidden mb-8">
                        <h2 class="text-lg font-medium text-primary mb-3">Upload Excel File</h2>
                        <label class="block w-full p-4 border-2 border-dashed border-gray-200 rounded-lg cursor-pointer hover:border-secondary transition-all bg-white/80 shadow-sm">
                            <input type="file" id="excelUpload" accept=".xlsx" class="hidden">
                            <div class="text-center text-neutral">
                                <svg class="w-8 h-8 mx-auto mb-2 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                <span>Drag & drop your Excel file here or click to upload (.xlsx)</span>
                            </div>
                        </label>
                        <div id="dataPreview" class="mt-6 hidden">
                            <h3 class="text-lg font-medium text-primary flex items-center gap-2 mb-3">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Data Preview
                            </h3>
                            <div id="dataTable" class="overflow-x-auto max-h-64 border border-gray-200 rounded-lg shadow-sm"></div>
                        </div>
                        <button id="generateButton" class="mt-4 bg-secondary text-white py-3 px-6 rounded-lg hover:bg-blue-500 focus:ring-4 focus:ring-blue-200 transition-all flex items-center gap-2 font-medium">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9H4m0 0v11h5m-5 0h11m-5-5h5m-5 0a8.001 8.001 0 01-5.418 2H4"></path></svg>
                            Generate PDFs by FINAL_AREA
                        </button>
                    </section>

                    <!-- Progress Section -->
                    <section id="progressSection" class="hidden mb-8">
                        <h2 class="text-lg font-medium text-primary mb-3">Processing Status</h2>
                        <div id="progressText" class="text-neutral mb-3"></div>
                        <div class="w-full bg-gray-200 rounded-full h-3 shadow-sm">
                            <div id="progressBar" class="bg-accent h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div id="resultSection" class="hidden mt-4 flex flex-col md:flex-row gap-3">
                            <div id="resultMessage" class="text-neutral flex-1"></div>
                            <div class="flex gap-3">
                                <button id="downloadButton" class="bg-accent text-white py-2 px-4 rounded-lg hover:bg-green-500 focus:ring-4 focus:ring-green-200 transition-all flex items-center gap-2 font-medium hidden">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Download ZIP
                                </button>
                                <button id="cleanupButton" class="bg-error text-white py-2 px-4 rounded-lg hover:bg-red-500 focus:ring-4 focus:ring-red-200 transition-all flex items-center gap-2 font-medium hidden">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4a1 1 0 011 1v1H9V4a1 1 0 011-1z"></path></svg>
                                    Cleanup Files
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- Error Message -->
                    <div id="errorMessage" class="hidden mt-4 p-4 bg-red-50 text-error rounded-lg flex items-center gap-2 animate-slide-down shadow-sm">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span></span>
                    </div>
                </div>

                <!-- User Management Section -->
                <div id="userManagementSection" class="hidden glass rounded-2xl shadow-glass p-8">
                    <h2 class="text-2xl font-semibold text-primary mb-6">User Management</h2>
                    <div class="mb-6">
                        <button id="addUserButton" class="bg-secondary text-white py-2 px-4 rounded-lg hover:bg-blue-500 focus:ring-4 focus:ring-blue-200 transition-all flex items-center gap-2 font-medium">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Add New User
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody" class="divide-y divide-gray-200">
                                <!-- Users will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
        <div class="glass p-8 rounded-2xl shadow-glass w-full max-w-md transform animate-fade-in">
            <h2 id="userModalTitle" class="text-2xl font-semibold text-primary mb-6 text-center">Add New User</h2>
            <form id="userForm">
                <div class="mb-4">
                    <label for="modalUsername" class="block text-sm font-medium text-neutral">Username</label>
                    <input type="text" id="modalUsername" class="mt-1 block w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all bg-white/80" placeholder="Enter username" required>
                </div>
                <div class="mb-4">
                    <label for="modalPassword" class="block text-sm font-medium text-neutral">Password</label>
                    <input type="password" id="modalPassword" class="mt-1 block w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all bg-white/80" placeholder="Enter password" required>
                </div>
                <div class="mb-6">
                    <label for="modalRole" class="block text-sm font-medium text-neutral">Role</label>
                    <select id="modalRole" class="mt-1 block w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-secondary focus:border-secondary transition-all bg-white/80">
                        <option value="Admin">Admin</option>
                        <option value="User">User</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-secondary text-white py-3 px-4 rounded-lg hover:bg-blue-500 focus:ring-4 focus:ring-blue-200 transition-all font-medium">Save</button>
                    <button type="button" id="cancelUserModal" class="flex-1 bg-gray-200 text-gray-800 py-3 px-4 rounded-lg hover:bg-gray-300 focus:ring-4 focus:ring-gray-200 transition-all font-medium">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        const API_BASE = 'http://localhost:5000/api';
        let users = { 'admin': { password: 'admin123', role: 'Admin' }, 'user': { password: 'user123', role: 'User' } };
        let editUserIndex = null;

        // Initialize UI
        document.addEventListener('DOMContentLoaded', () => {
            showSection('dlGeneratorSection');
            updateUserTable();
        });

        // Login handling
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Login successful! Role: ' + data.role);
                    currentUser = { username: data.username, role: data.role };
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    document.getElementById('userDisplay').textContent = `${data.username} (${data.role})`;
                    fetchFolders();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (error) {
                showError('Failed to login. Please check if the backend server is running.');
            }
        });

        // Logout handling
        document.getElementById('logoutButton').addEventListener('click', () => {
            currentUser = null;
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
            resetUI();
        });

        // Sidebar navigation
        document.getElementById('dlGeneratorMenu').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('dlGeneratorSection');
        });

        document.getElementById('userManagementMenu').addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUser.role !== 'Admin') {
                showError('Access denied. Admin role required.');
                return;
            }
            showSection('userManagementSection');
        });

        // Show specific section
        function showSection(sectionId) {
            document.getElementById('dlGeneratorSection').classList.add('hidden');
            document.getElementById('userManagementSection').classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');

            document.getElementById('dlGeneratorMenu').classList.remove('bg-white', 'bg-opacity-10', 'text-white');
            document.getElementById('dlGeneratorMenu').classList.add('text-gray-300');
            document.getElementById('userManagementMenu').classList.remove('bg-white', 'bg-opacity-10', 'text-white');
            document.getElementById('userManagementMenu').classList.add('text-gray-300');

            if (sectionId === 'dlGeneratorSection') {
                document.getElementById('dlGeneratorMenu').classList.add('bg-white', 'bg-opacity-10', 'text-white');
            } else if (sectionId === 'userManagementSection') {
                document.getElementById('userManagementMenu').classList.add('bg-white', 'bg-opacity-10', 'text-white');
            }
        }

        // Reset UI
        function resetUI() {
            document.getElementById('modeSelect').value = '';
            document.getElementById('selectionSection').classList.add('hidden');
            document.getElementById('folderSelect').innerHTML = '<option value="">Select Folder</option>';
            document.getElementById('dlTypeSelect').innerHTML = '<option value="">Select DL Type</option>';
            document.getElementById('templateSelect').innerHTML = '<option value="">Select Template</option>';
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('placeholdersDisplay').classList.add('hidden');
            document.getElementById('dataPreview').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '';
            document.getElementById('excelUpload').value = '';
            document.getElementById('dataTable').innerHTML = '';
        }

        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.querySelector('span').textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        // Fetch folders
        async function fetchFolders() {
            try {
                const response = await fetch(`${API_BASE}/folders`);
                const folders = await response.json();
                if (folders.error) {
                    showError(folders.error);
                    return;
                }
                const folderSelect = document.getElementById('folderSelect');
                folderSelect.innerHTML = '<option value="">Select Folder</option>';
                folders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder;
                    option.textContent = folder;
                    folderSelect.appendChild(option);
                });
            } catch (error) {
                showError('Failed to fetch folders. Please check FTP configuration.');
            }
        }

        // Fetch DL types
        async function fetchDLTypes(folder) {
            try {
                const response = await fetch(`${API_BASE}/dl_types`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder })
                });
                const dlTypes = await response.json();
                if (dlTypes.error) {
                    showError(dlTypes.error);
                    return;
                }
                const dlTypeSelect = document.getElementById('dlTypeSelect');
                dlTypeSelect.innerHTML = '<option value="">Select DL Type</option>';
                dlTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    dlTypeSelect.appendChild(option);
                });
            } catch (error) {
                showError('Failed to fetch DL types. Please check Google Sheets configuration.');
            }
        }

        // Fetch templates
        async function fetchTemplates(folder) {
            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder })
                });
                // Log the raw response status and headers for debugging
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                if (!response.ok) {
                    // Try to parse the error response
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.detail || `HTTP error: ${response.status}`;
                    showError(errorMessage);
                    return;
                }

                const data = await response.json();
                console.log('Response data:', data); // Log the parsed response

                // Extract templates array from the response
                const templates = data.templates || [];
                if (!Array.isArray(templates)) {
                    showError('Invalid templates format received from server.');
                    return;
                }

                const templateSelect = document.getElementById('templateSelect');

                if (data.message) {
                    document.getElementById('contentStatusText').textContent = data.message;
                    document.getElementById('contentStatus').classList.remove('hidden');
                }

                templateSelect.innerHTML = '<option value="">Select Template</option>';
                templates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template;
                    option.textContent = template;
                    templateSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Fetch error:', error); // Log the exact error
                showError(`Failed to fetch templates: ${error.message}. Please check FTP connection or server status.`);
            }
        }
        // Fetch placeholders
        async function fetchPlaceholders(folder, dl_type, template) {
            try {
                const response = await fetch(`${API_BASE}/placeholders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder, dl_type, template })
                });
                const data = await response.json();
                console.log(data)
                if (data.error) {
                    showError(data.error);
                    return;
                }   
                const placeholdersList = document.getElementById('placeholdersList');

                if (data.message) {
                    document.getElementById('templatecontentStatusText').textContent = data.message;
                    document.getElementById('templatecontentStatus').classList.remove('hidden');
                }

                placeholdersList.innerHTML = '';
                const placeholders = data.placeholders || [];
                placeholders.forEach(placeholder => {
                    const li = document.createElement('li');
                    li.textContent = placeholder;
                    placeholdersList.appendChild(li);
                });
                document.getElementById('placeholdersDisplay').classList.remove('hidden');
                document.getElementById('uploadSection').classList.remove('hidden');
            } catch (error) {
                showError('Failed to fetch placeholders. Please check template configuration.');
            }
        }

        // Event listeners for DL Generator
        document.getElementById('modeSelect').addEventListener('change', async (e) => {
            const mode = e.target.value;
            if (!mode) {
                resetUI();
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/set_mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                
                const data = await response.json();
                console.log(data)
                if (data.error) {
                    showError(data.error);
                    document.getElementById('modeSelect').value = '';
                    return;
                }
                resetUI();
                document.getElementById('modeSelect').value = mode;

                // Display template_status if exists
                if (data.template_status.transmittal_template) {
                    document.getElementById('templateStatusText').textContent = data.template_status.transmittal_template;
                    document.getElementById('statusDisplay').classList.remove('hidden');
                } else{
                    document.getElementById('statusDisplay').classList.add('hidden');
                }

                if (mode === 'Transmittal Only') {
                    document.getElementById('uploadSection').classList.remove('hidden');
                } else {
                    document.getElementById('selectionSection').classList.remove('hidden');
                    await fetchFolders();
                }
            } catch (error) {
                showError('Failed to set mode. Please check if the backend server is running.');
                document.getElementById('modeSelect').value = '';
            }
        });

        document.getElementById('folderSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                fetchDLTypes(e.target.value);
            }
        });

        document.getElementById('dlTypeSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                fetchTemplates(document.getElementById('folderSelect').value);
            }
        });

        document.getElementById('templateSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                fetchPlaceholders(
                    document.getElementById('folderSelect').value,
                    document.getElementById('dlTypeSelect').value,
                    e.target.value
                );
            }
        });

        document.getElementById('excelUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const response = await fetch(`${API_BASE}/upload_excel`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    const table = document.createElement('table');
                    table.className = 'min-w-full divide-y divide-gray-200';
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    Object.keys(data.data[0]).forEach(key => {
                        const th = document.createElement('th');
                        th.className = 'px-4 py-3 text-left text-xs font-medium text-neutral uppercase tracking-wider';
                        th.textContent = key;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                    const tbody = document.createElement('tbody');
                    tbody.className = 'divide-y divide-gray-200';
                    data.data.forEach(row => {
                        const tr = document.createElement('tr');
                        Object.values(row).forEach(value => {
                            const td = document.createElement('td');
                            td.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500';
                            td.textContent = value;
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    document.getElementById('dataTable').innerHTML = '';
                    document.getElementById('dataTable').appendChild(table);
                    document.getElementById('dataPreview').classList.remove('hidden');
                } catch (error) {
                    showError('Failed to upload Excel file. Please check file format.');
                }
            }
        });

        document.getElementById('generateButton').addEventListener('click', async () => {
            const file = document.getElementById('excelUpload').files[0];
            if (!file) {
                showError('Please upload an Excel file');
                return;
            }
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const resultSection = document.getElementById('resultSection');
            const downloadButton = document.getElementById('downloadButton');
            const cleanupButton = document.getElementById('cleanupButton');
            progressBar.style.width = '0%';
            progressText.textContent = 'Starting processing...';
            const formData = new FormData();
            formData.append('file', file);

            let timeoutId;
            const timeoutPromise = new Promise((_, reject) => {
                timeoutId = setTimeout(() => {
                    reject(new Error('Processing timed out after 120 seconds'));
                }, 120000);
            });

            try {
                const response = await Promise.race([
                    fetch(`${API_BASE}/generate_pdfs`, {
                        method: 'POST',
                        body: formData
                    }),
                    timeoutPromise
                ]);
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Server error');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let lastUpdate = Date.now();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // if (Date.now() - lastUpdate > 30000) {
                    //     throw new Error('No progress updates received for 30 seconds');
                    // }

                    try {
                        const chunk = decoder.decode(value, { stream: true });
                        const jsonObjects = chunk.split('\n').filter(line => line.trim());
                        for (const jsonStr of jsonObjects) {
                            try {
                                const data = JSON.parse(jsonStr);
                                if (data.error) {
                                    showError(data.error);
                                    return;
                                }
                                progressBar.style.width = `${data.progress}%`;
                                progressText.textContent = data.message;
                                lastUpdate = Date.now();
                                if (data.download_ready) {
                                    resultSection.classList.remove('hidden');
                                    downloadButton.classList.remove('hidden');
                                    cleanupButton.classList.remove('hidden');
                                    downloadButton.onclick = () => {
                                        window.location.href = `${API_BASE}/download_zip`;
                                    };
                                }
                            } catch (jsonError) {
                                console.error('Error parsing JSON chunk:', jsonError, jsonStr);
                            }
                        }
                    } catch (chunkError) {
                        console.error('Error processing chunk:', chunkError);
                    }
                }
            } catch (error) {
                clearTimeout(timeoutId);
                showError(`Failed to generate PDFs: ${error.message}`);
                progressText.textContent = 'Processing failed.';
                progressBar.style.width = '0%';
            }
        });

        document.getElementById('cleanupButton').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE}/cleanup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('resultSection').classList.add('hidden');
                    document.getElementById('progressSection').classList.add('hidden');
                    alert('Files cleaned up successfully!');
                    resetUI();
                } else {
                    showError(data.error || 'Failed to cleanup files');
                }
            } catch (error) {
                showError('Failed to cleanup files. Please check backend server.');
            }
        });

        // User Management Functions
        function updateUserTable() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            for (const username in users) {
                const user = users[username];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button class="edit-user text-blue-500 hover:underline mr-4 font-medium" data-username="${username}">Edit</button>
                        <button class="delete-user text-error hover:underline font-medium" data-username="${username}">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }

            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', (e) => {
                    const username = e.target.dataset.username;
                    editUser(username);
                });
            });

            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', (e) => {
                    const username = e.target.dataset.username;
                    deleteUser(username);
                });
            });
        }

        document.getElementById('addUserButton').addEventListener('click', () => {
            editUserIndex = null;
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('modalUsername').value = '';
            document.getElementById('modalPassword').value = '';
            document.getElementById('modalRole').value = 'Admin';
            document.getElementById('modalUsername').disabled = false;
            document.getElementById('userModal').classList.remove('hidden');
        });

        document.getElementById('cancelUserModal').addEventListener('click', () => {
            document.getElementById('userModal').classList.add('hidden');
        });

        document.getElementById('userForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('modalUsername').value;
            const password = document.getElementById('modalPassword').value;
            const role = document.getElementById('modalRole').value;

            if (editUserIndex === null) {
                if (users[username]) {
                    alert('Username already exists.');
                    return;
                }
                users[username] = { password, role };
            } else {
                const oldUsername = editUserIndex;
                if (oldUsername !== username && users[username]) {
                    alert('Username already exists.');
                    return;
                }
                delete users[oldUsername];
                users[username] = { password, role };
            }

            updateUserTable();
            document.getElementById('userModal').classList.add('hidden');
        });

        function editUser(username) {
            editUserIndex = username;
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('modalUsername').value = username;
            document.getElementById('modalPassword').value = users[username].password;
            document.getElementById('modalRole').value = users[username].role;
            document.getElementById('modalUsername').disabled = false;
            document.getElementById('userModal').classList.remove('hidden');
        }

        function deleteUser(username) {
            if (username === currentUser.username) {
                alert('You cannot delete your own account while logged in.');
                return;
            }
            if (confirm(`Are you sure you want to delete user "${username}"?`)) {
                delete users[username];
                updateUserTable();
            }
        }
        
    </script>
</body>
</html>